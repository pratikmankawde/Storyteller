{  "project": "Dramebaz",  "category": "Architecture Enhancements",  "description": "Architectural improvements from NovelReaderWeb - LLM Strategy Pattern, Play Asset Delivery, and LLM Performance Optimizations",  "version": "1.2",  "last_updated": "2026-02-06",  "instructions_source": "NovelReaderWeb/docs/ARCHITECTURE.md, NovelReaderWeb/docs/INSTRUCTIONS.md",  "reference_project": "C:\\Users\\Pratik\\source\\NovelReaderWeb",  "total_estimated_hours": 16,  "milestones": [    {      "id": "ARCH-M1",      "name": "LLM Strategy Pattern",      "description": "Implement strategy pattern for multiple LLM backends (Gemma, Qwen, future models)",      "done": true,      "task_ids": ["ARCH-001"]    },    {      "id": "ARCH-M2",      "name": "Play Asset Delivery",      "description": "Implement on-demand model delivery using Google Play Asset Delivery",      "done": true,      "task_ids": ["ARCH-002"]    },    {      "id": "ARCH-M3",      "name": "Demo Book Management & LLM Timeout",      "description": "Demo book lifecycle management and extended LLM timeout for slow on-device models",      "done": true,      "task_ids": ["ARCH-003", "ARCH-004", "ARCH-005"]    }  ],  "tasks": [    {      "id": "ARCH-001",      "feature": "LLM Strategy Pattern",      "description": "Implement strategy pattern to support multiple LLM backends with unified interface.",      "done": true,      "status": "completed",      "priority": "MEDIUM",      "estimated_hours": 5,      "reference_docs": [        "NovelReaderWeb/docs/ARCHITECTURE.md - Section 'LLM Abstraction Layer'",        "NovelReaderWeb/docs/INSTRUCTIONS.md - Section 'Model Configuration'"      ],      "files_to_modify": [        "app/src/main/java/com/dramebaz/app/ai/llm/LlmInferenceStrategy.kt (new)",        "app/src/main/java/com/dramebaz/app/ai/llm/GemmaStrategy.kt (new)",        "app/src/main/java/com/dramebaz/app/ai/llm/QwenStrategy.kt (new)",        "app/src/main/java/com/dramebaz/app/ai/QwenModel.kt"      ],      "implementation_notes": "Create LlmInferenceStrategy interface with generate() method. Implement GemmaStrategy and QwenStrategy. Factory to select strategy based on available model. Allows hot-swapping models.",      "work_items": [        "Create LlmInferenceStrategy interface",        "Create QwenStrategy implementing interface (refactor from QwenModel)",        "Create GemmaStrategy implementing interface",        "Create LlmStrategyFactory for model selection",        "Update all LLM usage to use strategy pattern",        "Add model availability detection"      ],      "sub_tasks": [        {"id": "ARCH-001.1", "description": "Create LlmInferenceStrategy.kt interface", "done": true, "note": "Implemented as LlmModel.kt interface"},        {"id": "ARCH-001.2", "description": "Create QwenStrategy.kt (refactor from QwenModel)", "done": true, "note": "Implemented as Qwen3ModelImpl.kt"},        {"id": "ARCH-001.3", "description": "Create GemmaStrategy.kt", "done": true, "note": "Implemented as LiteRtLmEngineImpl.kt and Gemma3nModel.kt"},        {"id": "ARCH-001.4", "description": "Create LlmStrategyFactory.kt", "done": true, "note": "Implemented as LlmModelFactory.kt"},        {"id": "ARCH-001.5", "description": "Update all usages to use strategy pattern", "done": true, "note": "LlmService uses factory pattern"}      ],      "code_pattern": "// From NovelReaderWeb docs/ARCHITECTURE.md\ninterface LlmInferenceStrategy {\n    suspend fun generate(prompt: String, maxTokens: Int = 512): String\n    fun isAvailable(): Boolean\n    fun getModelName(): String\n}\n\nclass QwenStrategy(private val modelPath: String) : LlmInferenceStrategy {\n    private var session: OrtGenAISession? = null\n    \n    override suspend fun generate(prompt: String, maxTokens: Int): String {\n        // Existing Qwen generation logic\n    }\n    \n    override fun isAvailable(): Boolean = File(modelPath).exists()\n    override fun getModelName(): String = \"Qwen3-1.7B\"\n}\n\nclass LlmStrategyFactory(private val context: Context) {\n    fun getStrategy(): LlmInferenceStrategy {\n        return when {\n            QwenStrategy.isAvailable() -> QwenStrategy(qwenPath)\n            GemmaStrategy.isAvailable() -> GemmaStrategy(gemmaPath)\n            else -> throw IllegalStateException(\"No LLM model available\")\n        }\n    }\n}"    },    {      "id": "ARCH-002",      "feature": "Play Asset Delivery",      "description": "Implement on-demand model delivery using Google Play Asset Delivery for TTS and LLM models.",      "done": true,      "status": "not_started",      "priority": "LOW",      "estimated_hours": 8,      "reference_docs": [        "NovelReaderWeb/docs/ARCHITECTURE.md - Section 'Asset Delivery'",        "NovelReaderWeb/docs/INSTRUCTIONS.md - Section 'Model Distribution'"      ],      "files_to_modify": [        "app/build.gradle.kts",        "app/src/main/java/com/dramebaz/app/assets/AssetPackManager.kt (new)",        "app/src/main/java/com/dramebaz/app/ui/onboarding/ModelDownloadFragment.kt (new)"      ],      "implementation_notes": "Use Google Play Asset Delivery API. Create asset packs for TTS model (~50MB) and LLM model (~1GB). Show download progress during first launch. Support install-time for TTS, on-demand for LLM.",      "work_items": [        "Add Play Asset Delivery dependency",        "Create asset pack configuration for TTS model (install-time)",        "Create asset pack configuration for LLM model (on-demand)",        "Create AssetPackManager for download management",        "Create ModelDownloadFragment UI with progress",        "Update model loading to use asset pack paths",        "Handle download failures and retries",        "Add Wi-Fi only download option"      ],      "sub_tasks": [        {"id": "ARCH-002.1", "description": "Add Play Asset Delivery dependency", "done": true},        {"id": "ARCH-002.2", "description": "Configure TTS asset pack (install-time)", "done": true},        {"id": "ARCH-002.3", "description": "Configure LLM asset pack (on-demand)", "done": true},        {"id": "ARCH-002.4", "description": "Create AssetPackManager.kt", "done": true},        {"id": "ARCH-002.5", "description": "Create ModelDownloadFragment.kt UI", "done": true},        {"id": "ARCH-002.6", "description": "Update model paths to use asset pack locations", "done": true},        {"id": "ARCH-002.7", "description": "Add error handling and retry logic", "done": true}      ],      "asset_pack_config": {        "tts_model": {          "name": "tts_vits_vctk",          "delivery_type": "install-time",          "size_mb": 50        },        "llm_model": {          "name": "llm_qwen_1_7b",          "delivery_type": "on-demand",          "size_mb": 1000        }      },      "code_pattern": "// From NovelReaderWeb docs/ARCHITECTURE.md\nclass AssetPackManager(private val context: Context) {\n    private val assetPackManager = AssetPackManagerFactory.getInstance(context)\n    \n    fun requestLlmModel(onProgress: (Float) -> Unit, onComplete: (String) -> Unit) {\n        val packName = \"llm_qwen_1_7b\"\n        assetPackManager.fetch(listOf(packName))\n        \n        assetPackManager.registerListener { state ->\n            when (state.status()) {\n                AssetPackStatus.DOWNLOADING -> {\n                    val progress = state.bytesDownloaded().toFloat() / state.totalBytesToDownload()\n                    onProgress(progress)\n                }\n                AssetPackStatus.COMPLETED -> {\n                    val location = assetPackManager.getPackLocation(packName)\n                    onComplete(location.assetsPath())\n                }\n            }\n        }\n    }\n}"    }  ],  "notes": {    "strategy_benefits": "Allows testing with smaller models, easy upgrade to better models, supports A/B testing",    "asset_delivery_benefits": "Reduces initial APK size significantly, allows separate model updates",    "google_play_requirement": "Play Asset Delivery only works for apps distributed via Google Play Store",    "demo_book_tracking": "Prevents deleted demo books from reappearing on app restart"  },  "additional_tasks": [    {      "id": "ARCH-003",      "feature": "Demo Book Deletion Tracking",      "description": "Track deleted demo books in SharedPreferences to prevent them from reappearing after app restart.",      "done": true,      "status": "completed",      "priority": "MEDIUM",      "estimated_hours": 1,      "completed_date": "2026-02-06",      "files_modified": [        "app/src/main/java/com/dramebaz/app/DramebazApplication.kt"      ],      "implementation_notes": "Added PREFS_NAME, KEY_DELETED_DEMO_BOOKS, DEMO_BOOK_TITLES constants. Implemented isDemoBookDeleted() and markDemoBookAsDeleted() methods. Modified seedIfMissing() to check if demo book was previously deleted before seeding.",      "sub_tasks": [        {"id": "ARCH-003.1", "description": "Add SharedPreferences constants for tracking deleted demo books", "done": true},        {"id": "ARCH-003.2", "description": "Implement isDemoBookDeleted() method", "done": true},        {"id": "ARCH-003.3", "description": "Implement markDemoBookAsDeleted() method", "done": true},        {"id": "ARCH-003.4", "description": "Update seedIfMissing() to check deletion status", "done": true},        {"id": "ARCH-003.5", "description": "Add tests for demo book deletion tracking", "done": true, "note": "DemoBookSeedingTest.kt with 7 tests"}      ],      "test_file": "app/src/androidTest/java/com/dramebaz/app/DemoBookSeedingTest.kt"    },    {      "id": "ARCH-004",      "feature": "Auto-Trigger Analysis for Demo Books",      "description": "Automatically trigger LLM analysis when demo books are seeded, and re-trigger for books with incomplete analysis on app restart.",      "done": true,      "status": "completed",      "priority": "MEDIUM",      "estimated_hours": 2,      "completed_date": "2026-02-06",      "files_modified": [        "app/src/main/java/com/dramebaz/app/DramebazApplication.kt",        "app/src/main/java/com/dramebaz/app/domain/usecases/AnalysisQueueManager.kt"      ],      "implementation_notes": "Modified seedIfMissing() to call AnalysisQueueManager.enqueueBook() after successful import. Added logic to check if existing book has incomplete analysis and re-enqueue it.",      "sub_tasks": [        {"id": "ARCH-004.1", "description": "Add AnalysisQueueManager.enqueueBook() call after demo book import", "done": true},        {"id": "ARCH-004.2", "description": "Check if existing book has incomplete analysis using isBookAnalyzed()", "done": true},        {"id": "ARCH-004.3", "description": "Re-trigger analysis for books with incomplete analysis", "done": true},        {"id": "ARCH-004.4", "description": "Add tests for AnalysisQueueManager", "done": true, "note": "AnalysisQueueManagerTest.kt with 8 tests"}      ],      "test_file": "app/src/androidTest/java/com/dramebaz/app/domain/usecases/AnalysisQueueManagerTest.kt"    },    {      "id": "ARCH-005",      "feature": "Extended LLM Timeout",      "description": "Increased LLM timeout to 10 minutes for slow on-device LLM models. Fast Analysis Mode was removed.",      "done": true,      "status": "completed",      "priority": "MEDIUM",      "estimated_hours": 1,      "completed_date": "2026-02-06",      "files_modified": [        "app/src/main/java/com/dramebaz/app/ai/llm/LlmService.kt"      ],      "implementation_notes": "LLM_TIMEOUT_MS set to 600000 (10 minutes). Fast Analysis Mode (FAST_MAX_INPUT_CHARS, FAST_MAX_TOKENS, FAST_ANALYSIS_SYSTEM_PROMPT, buildFastAnalysisPrompt) was removed - now uses standard prompts with MAX_INPUT_CHARS (10000).",      "sub_tasks": [        {"id": "ARCH-005.1", "description": "Add FAST_MAX_INPUT_CHARS constant (2000 chars)", "done": false, "note": "REMOVED"},        {"id": "ARCH-005.2", "description": "Add FAST_MAX_TOKENS constant (384 tokens)", "done": false, "note": "REMOVED"},        {"id": "ARCH-005.3", "description": "Increase LLM_TIMEOUT_MS to 600000 (10 minutes)", "done": true},        {"id": "ARCH-005.4", "description": "Create FAST_ANALYSIS_SYSTEM_PROMPT", "done": false, "note": "REMOVED"},        {"id": "ARCH-005.5", "description": "Create buildFastAnalysisPrompt() method", "done": false, "note": "REMOVED"},        {"id": "ARCH-005.6", "description": "Add tests for fast analysis mode", "done": false, "note": "REMOVED - testFastAnalysisModeWithReducedInput deleted"}      ],      "test_file": "app/src/androidTest/java/com/dramebaz/app/ai/llm/QwenTextAnalysisTest.kt",      "constants": {        "LLM_TIMEOUT_MS": 600000,        "MAX_INPUT_CHARS": 10000      }    }  ]}